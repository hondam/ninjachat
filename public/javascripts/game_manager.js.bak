define(['ws_client', 'scene_factory', 'player', 'lib/class'], 
  function(WsClient, SceneFactory, Player) {

  /**
   *
   */
  var GameManager = Class.extend({

    /**
     * コンストラクタ
     * @constructor
     */
    init: function() {
      this.initScene_();
      this.initWsClient_();
    },

    /**
     * @private
     */
    initPlayer_: function() {
      //this.player = new Player();
    },

    /**
     * @private
     */
    initScene_: function() {
      // Scene
      this.scenes = [];
      this.sf = new SceneFactory();
      this.scenes['main'] = this.sf.createScene('main');
      this.scenes['room01'] = this.sf.createScene('room01');
      this.currentScene = this.getSceneByName_('main');
    },

    /**
     * @private
     */
    initWsClient_: function() {
      var self = this;

      // WebSocket Client
      this.client = new WsClient('210.152.137.37', '3000');

      /**
       * サーバ接続時のコールバック
       */
      this.client.onConnected(function() {
        console.log('GameManager - onConnected');
      });

      /**
       * サーバからウェルカムメッセージを受け取った場合のコールバック
       */
      this.client.onWelcome(function(aData) {
        console.log('GameManager - onWelcome');

        this.player = new Player(aData[2].id, aData[2].name, aData[2].kind);
        this.player.setGridPosition(aData[2].x, aData[2].y);
        //self.currentScene.addChild(self.player);
        self.currentScene.setPlayer(this.player);
      });

      /**
       * サーバからキャラ追加メッセージを受け取った場合のコールバック
       */
      this.client.onSpawn(function(aData) {
        console.log('GameManager - onSpawn');

        var mSceneName = aData[1];
        var cSceneName = self.getCurrentSceneName();
        if (mSceneName === cSceneName) {
          // 追加キャラをシーンへ表示
        }
      });

      /**
       * サーバからキャラ削除メッセージを受け取った場合のコールバック
       */
      this.client.onDespawn(function(aData) {
        console.log('GameManager - onDespawn');

        var mSceneName = aData[1];
        var cSceneName = self.getCurrentSceneName();
        if (mSceneName === cSceneName) {
          // 追加キャラをシーンから削除
        }
      });

      /**
       * サーバから移動メッセージを受け取った場合のコールバック
       */
      this.client.onMove(function(aData) {
        console.log('GameManager - onMove', aData);

        var mSceneName = aData[1];
        var cSceneName = self.getCurrentSceneName();
        if (mSceneName === cSceneName) {
          // キャラを移動

          this.player.move(aData[3]);
          //self.currentScene.player.move(aData[3]);
        }
      });

      /**
       * サーバからチャットメッセージを受け取った場合のコールバック
       */
      this.client.onChat(function(aData) {
        console.log('GameManager - onChat');

        var mSceneName = aData[1];
        var cSceneName = self.getCurrentSceneName();
        if (mSceneName === cSceneName) {
          // チャットをシーンへ表示
        }
      });

      /**
       * サーバからシーン変更を受け取った場合のコールバック
       */
      this.client.onScene(function(aData) {
        console.log('GameManager - onScene', aData);

        var mSceneName = aData[1];
        var cSceneName = self.getCurrentSceneName();
        if (mSceneName !== cSceneName) {
          // wait & go
          var moveWaiting = setInterval(function() {
            if (this.player.isMoving === false) {
              clearInterval(moveWaiting);
              this.player.x = aData[3];
              this.player.y = aData[4];
              //self.scenes[mSceneName].stage.addChild(self.player);
              self.scenes[mSceneName].setPlayer(this.player);
              self.changeScene(cSceneName, mSceneName);
            } else {
              console.log('move waiting...');
            }
          }, 100);
        }
      });

      /**
       * サーバからキャラクタリストメッセージを受け取った場合のコールバック
       */
      this.client.onEntities(function(aData) {
        console.log('GameManager - onEntities');

        var mSceneName = aData[1];
        var cSceneName = self.getCurrentSceneName();
        if (mSceneName === cSceneName) {
          self.currentScene.waitInTheWings(aData[2]);
        }
      });

      /**
       *
       */
      this.client.onDirection(function(aData) {
        console.log('GameManager - onDirection');

        var mSceneName = aData[1];
        var cSceneName = self.getCurrentSceneName();
        if (mSceneName === cSceneName) {

          self.player.changeOfDirection(aData[3]);

        }
      });

      this.client.onDisconnected(function(aData) {
        console.log('GameManager - onDisconnected');

        // キャラをマップから削除
      });

      this.client.onError(function() {
        console.log('GameManager - onError');

        // エラーを画面に表示
      });

    },

    /**
     * WebSocketサーバへ接続する
     * @public
     */
    connect: function() {
      console.log('GameManager - connect');
      if (this.client) {
        this.client.connect();
      }
    },

    /**
     * ゲームを開始する
     * @public
     */
    tryStarting: function() {
      console.log('GameManager - tryStarting');
      var self = this;
      var watchCanStart = setInterval(function() {
        if (self.client.connected) {
          clearInterval(watchCanStart);

          self.start_();

        } else {
          console.log('start waiting...');
        }
      }, 100);
    },

    /**
     * @private
     */
    start_: function() {
      console.log('GameManager - start_');

      // シーン開始
      this.currentScene.go();
    },

    /**
     * 指定IDのシーンへ変更する
     * @public
     */
    changeScene: function(aCSceneName, aNSceneName) {
      console.log('GameManager - changeScene', aCSceneName, '>', aNSceneName);

      this.currentScene = this.getSceneByName_(aNSceneName);
      this.currentScene.go(aCSceneName);
    },

    /**
     * 現在のシーン名を返す
     * @public
     */
    getCurrentSceneName: function() {
      console.log('GameManager - getCurrentSceneName');
      return this.currentScene.name;
    },

    /**
     * 指定IDのシーンを取得する
     * @private
     */
    getSceneByName_: function(aName) {
      console.log('GameManager - getSceneByName_');
      return this.scenes[aName];
    },

    /**
     * サーバへMoveメッセージを送信する
     * @public
     */
    sendMove: function(aDirection) {
      var self = this;
      self.client.sendMove(self.getCurrentSceneName(), self.player.id, aDirection);
    }

  });
  return GameManager;
});

